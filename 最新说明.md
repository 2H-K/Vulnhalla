## 最新说明

本说明基于当前代码实现，对原有 `tips.md`、`关于原作者处理不好路径转换的问题.md`、`SECURITY.md` 的内容进行合并与更新，**以项目现状为准**。如需英文版本和完整安装细节，请参考 `README.md`。

---

## 项目定位与当前能力

Vulnhalla 是一个基于 **CodeQL + LLM** 的自动化安全分析流水线，用于从海量 CodeQL 告警中筛选更可信的结果，并保存结构化输出以便 UI 浏览。

- **核心流程**：获取或使用本地数据库 → 运行 CodeQL 查询 → LLM 分类与补全 → 输出结果。
- **结果形态**：`output/results/<lang>/<issue_type>/` 下保存 `*_raw.json` 与 `*_final.json`。
- **状态码体系**：
  - **1337**：确认存在安全问题（True Positive）
  - **1007**：确认安全（False Positive）
  - **7331/3713**：需要更多上下文或倾向非漏洞

---

## 当前代码结构（关键模块）

- **流水线入口**：`src/pipeline.py` 负责拉取数据库、执行查询、调用 LLM。
- **查询执行**：`src/codeql/run_codeql_queries.py` 预编译并运行 `data/queries/<lang>/issues` 与 `data/queries/<lang>/tools`。
- **LLM 分析**：`src/llm/llm_analyzer.py` 负责提示词与工具调用（函数/类/宏等）。
- **问题聚合与上下文构建**：`src/vulnhalla.py` 解析 CSV、读取 `src.zip`、构建提示词并写入结果。
- **路径统一处理**：`src/utils/path_normalizer.py` 为跨平台路径修复提供一致逻辑。

---

## 数据库结构与路径处理（已集中化）

**当前路径处理已集中到 `PathNormalizer`，并在多个模块中复用**，以解决不同系统、不同 CodeQL 版本下路径格式不一致的问题：

- **`sourceLocationPrefix` 统一处理**：
  - Linux `/abs/path` → `abs/path`
  - Windows `C:\path` → `C_/path`
  - 自动移除 `relative://` / `file://` 等 scheme
- **ZIP 读取兼容**：同一路径会尝试 **冒号版本** 与 **下划线版本**，提升跨平台成功率。
- **FunctionTree.csv 匹配**：按相对路径或文件名进行更稳健匹配，并使用“最小范围函数”作为最佳匹配。

**数据库目录结构建议**：

```
output/databases/<lang>/<org>/<repo>/
├── codeql-database.yml
├── src.zip
├── FunctionTree.csv
└── issues.csv
```

若仍出现 “文件不存在于 ZIP” 的问题，建议检查：
- `codeql-database.yml` 中的 `sourceLocationPrefix`
- `src.zip` 内部实际路径结构
- 是否为跨系统生成的数据库（Windows ↔ Linux）

---

## LLM 分析机制（现状）

- **LLM 统一接入**：使用 `litellm`，支持多供应商配置（具体以 `.env` 为准）。
- **工具调用能力**：可按需取回函数、调用方、类/结构体、宏、全局变量等。
- **缓存**：开启时写入 `output/cache`，避免重复调用成本。
- **上下文安全机制**：
  - 过滤静态资源（如 `dist/`, `node_modules/`, `*.min.js` 等）。
  - JavaScript 压缩代码会尝试 beautify。
  - 采用**硬上限 token 熔断**，避免超长 prompt。

---

## 使用方式（与当前实现一致）

### 1) 一键流水线（推荐）

```bash
# 远程模式：默认分析 top repos
python src/pipeline.py

# 远程模式：分析指定仓库
python src/pipeline.py redis/redis --language c

# 本地数据库模式：使用 output/databases/<lang>/<db_dir>
python src/pipeline.py local-db <db_dir> --language c
```

### 2) 仅运行查询

```bash
python -m src.codeql.run_codeql_queries -l java --db-dir webgoat
```

### 3) 仅运行 LLM 分析

```bash
python src/vulnhalla.py local-db <db_dir> --language c
```

> 如需 UI，请参考 `README.md` 中的 UI 运行说明。

---

## 研究性改进方向（可选，非当前实现）

以下是从 `tips.md` 与研究笔记中提炼的 **未来方向**，与当前代码实现**不完全等价**：

- **免编译建库**：探索 `codeql database create --build-mode none` 降低资源消耗。
- **更强的推理模式**：从“误报过滤”向“主动推理”演进。
- **符号对齐验证**：引入解析器或 AST 校验抑制幻觉。
- **对比提示词工程**：用易损/修复对比提升可解释性。
- **加权评分**：结合 CodeQL 与 LLM 结果形成综合置信度。

