å¥½ï¼Œé—®åˆ°ç‚¹å­ä¸Šäº†ã€‚è®©æˆ‘ç»™ä½ æ‹†è§£æ•´ä¸ªæŸ¥æ‰¾æµç¨‹â€”â€”è¿™ç¡®å®æ˜¯bugçš„é«˜å‘åŒºã€‚

---

## å®Œæ•´æŸ¥æ‰¾æµç¨‹ï¼šä»CodeQLæ•°æ®åº“åˆ°æºç æ–‡ä»¶

### 1ï¸âƒ£ CodeQLæ•°æ®åº“çš„æ ¸å¿ƒæ–‡ä»¶
æ¯ä¸ªCodeQLæ•°æ®åº“ç›®å½•åŒ…å«ï¼š
```
your-repo-db/
â”œâ”€â”€ codeql-database.yml    # æ•°æ®åº“å…ƒæ•°æ®ï¼ŒåŒ…å«sourceLocationPrefix
â”œâ”€â”€ src.zip                # æ‰€æœ‰æºç æ–‡ä»¶å‹ç¼©åŒ…
â”œâ”€â”€ FunctionTree.csv       # å‡½æ•°ä½ç½®æ˜ å°„è¡¨
â””â”€â”€ issues.csv             # CodeQLæŸ¥è¯¢ç»“æœ
```

### 2ï¸âƒ£ æŸ¥æ‰¾æ­¥éª¤ï¼ˆåœ¨[process_issue_type](src/vulnhalla.py#L487-L550)ä¸­ï¼‰

**æ­¥éª¤1ï¼šè¯»å–è·¯å¾„å‰ç¼€**
```python
db_yml = read_yml(str(db_path_obj / "codeql-database.yml"))
self.code_path = db_yml["sourceLocationPrefix"]
```
- è¿™ä¸ªå­—æ®µé€šå¸¸ç±»ä¼¼ï¼š
  - Linux: `/home/user/project/`
  - Windows: `C:\Users\user\project\`

**æ­¥éª¤2ï¼šè·¯å¾„æ ‡å‡†åŒ–ï¼ˆè¿™æ˜¯bugæœ€å¤šçš„åœ°æ–¹ï¼ï¼‰**
```python
if ":" in self.code_path:
    # Windowsè·¯å¾„ï¼šC:\path â†’ C_/path
    self.code_path = self.code_path.replace(":", "_").replace("\\", "/")
else:
    # Linuxè·¯å¾„ï¼š/absolute/path â†’ absolute/path
    self.code_path = self.code_path[1:]  # å»æ‰å‰å¯¼æ–œæ 
```

**ä¸ºä»€ä¹ˆè¦æ ‡å‡†åŒ–ï¼Ÿ**
å› ä¸ºZIPå†…éƒ¨è·¯å¾„ä½¿ç”¨POSIXæ ¼å¼ï¼ˆ`/`åˆ†éš”ç¬¦ï¼‰ï¼ŒWindowsçš„`:`ä¼šæ··æ·†è·¯å¾„è§£æã€‚

**æ­¥éª¤3ï¼šæ‹¼æ¥å®Œæ•´è·¯å¾„**
```python
full_file_path = self.code_path + issue["file"]
```
- `issue["file"]`æ¥è‡ª[issues.csv](src/vulnhalla.py#L67-L98)ï¼Œæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚`src/main.c`ï¼‰
- æœ€ç»ˆè·¯å¾„ï¼š`C_/Users/user/project/src/main.c`

**æ­¥éª¤4ï¼šä»src.zipè¯»å–æ–‡ä»¶**
```python
code_file_contents = read_file_lines_from_zip(src_zip_path, full_file_path).split("\n")
```

---

## ä½ é‡åˆ°çš„"æ‰¾ä¸åˆ°æ–‡ä»¶"bugå¯èƒ½åœ¨å“ªé‡Œ

### ğŸ”´ é«˜é£é™©ç‚¹1ï¼šè·¯å¾„æ ¼å¼ä¸åŒ¹é…
**ç°è±¡**ï¼š`CodeQLError: File 'xxx' not found in ZIP archive`

**åŸå› **ï¼š
- `codeql-database.yml`çš„`sourceLocationPrefix`æ ¼å¼å¼‚å¸¸
  - å¯èƒ½æ˜¯Windowsä¸‹ç”Ÿæˆçš„æ•°æ®åº“åœ¨Linuxä¸Šè¿è¡Œ
  - æˆ–è€…è·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦/ç©ºæ ¼

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹codeql-database.ymlå†…å®¹
cat output/dbs/cpp/xxx/codeql-database.yml | grep sourceLocationPrefix

# æŸ¥çœ‹src.zipä¸­çš„å®é™…è·¯å¾„ç»“æ„
unzip -l output/dbs/cpp/xxx/src.zip
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
å¦‚æœè·¯å¾„æ ¼å¼å®Œå…¨ä¸ä¸€è‡´ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹`codeql-database.yml`æˆ–æ·»åŠ è·¯å¾„æ˜ å°„é€»è¾‘ã€‚

---

### ğŸ”´ é«˜é£é™©ç‚¹2ï¼šFunctionTree.csvè·¯å¾„ä¸åŒ¹é…
**ç°è±¡**ï¼šæ‰¾ä¸åˆ°å‡½æ•°ï¼Œæˆ–è€…æ‰¾åˆ°é”™è¯¯çš„å‡½æ•°

**åŸå› **ï¼š
åœ¨[find_function_by_line](src/vulnhalla.py#L141-L197)ä¸­ï¼š
```python
if file_path in row:  # ä½¿ç”¨å­å­—ç¬¦ä¸²åŒ¹é…
```
- `issue["file"]`æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚`src/main.c`ï¼‰
- `FunctionTree.csv`ä¸­çš„`file`å¯èƒ½æ˜¯ï¼š
  - ç›¸å¯¹è·¯å¾„ï¼š`src/main.c` âœ…
  - ç»å¯¹è·¯å¾„ï¼š`/home/user/project/src/main.c` âŒ
  - Windowsè·¯å¾„ï¼š`C:\project\src\main.c` âŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹åŒ¹é…é€»è¾‘ï¼Œå…ˆæå–æ–‡ä»¶åå†åŒ¹é…ï¼š
```python
file_name = PurePosixPath(file_path).name
if file_name in row:
    # æå–å®Œæ•´è·¯å¾„åå†åˆ¤æ–­
```

---

### ğŸ”´ é«˜é£é™©ç‚¹3ï¼šbracket referenceè·¯å¾„è§£æå¤±è´¥
**ç°è±¡**ï¼šå¤„ç†CodeQLå¼•ç”¨æ—¶å´©æºƒï¼ˆ`[var, path_type, file_path, line...]`ï¼‰

**åŸå› **ï¼š
åœ¨[create_bracket_reference_replacer](src/vulnhalla.py#L224-L272)ä¸­ï¼š
```python
if path_type == "relative://":
    full_path = code_path + file_path
else:
    full_path = file_path[1:] if file_path.startswith("/") else file_path
```
- å¦‚æœ`path_type`ä¸æ˜¯`relative://`ï¼Œä¸”`file_path`æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¼šç›´æ¥æ‹¼æ¥å¤±è´¥
- ä¸åŒCodeQLç‰ˆæœ¬ç”Ÿæˆçš„`path_type`å¯èƒ½ä¸åŒ


**ä¸æ˜¯ã€‚** è·¯å¾„å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™å¯èƒ½æ˜¯bugçš„å¦ä¸€ä¸ªæ¥æºã€‚

---

## è·¯å¾„å¤„ç†ä»£ç åˆ†å¸ƒå›¾

### ğŸ“ **æ ¸å¿ƒè·¯å¾„è½¬æ¢ï¼ˆæœ€å¤æ‚ï¼‰**
**[vulnhalla.py](src/vulnhalla.py)** - IssueAnalyzerç±»
```python
# Line 487-550: process_issue_type
# è·¯å¾„æ ‡å‡†åŒ–é€»è¾‘ï¼ˆWindows/Linuxå…¼å®¹ï¼‰
if ":" in self.code_path:
    self.code_path = self.code_path.replace(":", "_").replace("\\", "/")
else:
    self.code_path = self.code_path[1:]

# Line 224-272: create_bracket_reference_replacer  
# å¤„ç†CodeQL bracket referenceçš„è·¯å¾„
if path_type == "relative://":
    full_path = code_path + file_path
else:
    full_path = file_path[1:] if file_path.startswith("/") else file_path
```

### ğŸ“ **æ•°æ®åº“æŸ¥è¯¢ä¸­çš„è·¯å¾„å¤„ç†**
**[db_lookup.py](src/codeql/db_lookup.py)** - CodeQLDBLookupç±»
```python
# Line 356-373: extract_function_lines_from_db
# æ³¨æ„ï¼šç›´æ¥å»æ‰å‰å¯¼æ–œæ ï¼Œæ²¡æœ‰è€ƒè™‘Windowsè·¯å¾„ï¼
file_path = current_function["file"].replace("\"", "")[1:]  # âš ï¸ åªå»ç¬¬ä¸€ä¸ªå­—ç¬¦

# Line 84-113: get_function_by_line
# ä½¿ç”¨å­å­—ç¬¦ä¸²åŒ¹é…è·¯å¾„
if file in function:  # âš ï¸ å¯èƒ½åŒ¹é…åˆ°é”™è¯¯è·¯å¾„
    row_dict = parse_csv_row(function, keys)
```

### ğŸ“ **ç»“æœåŠ è½½ä¸­çš„è·¯å¾„è§£æ**
**[results_loader.py](src/ui/results_loader.py)** - ResultsLoaderç±»
```python
# Line 222-242: _extract_repo_from_db_path
# ä»æ•°æ®åº“è·¯å¾„æå–ä»“åº“å
db_path_obj = Path(db_path)
repo_name = db_path_obj.name
org_name = db_path_obj.parent.name

# Line 206-214: _extract_file_info
# æå–æ–‡ä»¶åç”¨äºæ˜¾ç¤º
return (PurePosixPath(file_path).name if file_path else "unknown", ...)
```

### ğŸ“ **åº•å±‚å·¥å…·å‡½æ•°**
**[common_functions.py](src/utils/common_functions.py)**
```python
# Line 122-148: read_file_lines_from_zip
# ä»ZIPè¯»å–æ–‡ä»¶çš„åº•å±‚å®ç°
with zipfile.ZipFile(zip_path, 'r') as zip_ref:
    with zip_ref.open(file_path_in_zip) as file:
        return file.read().decode('utf-8')
```

---

## ğŸ”´ å‘ç°çš„æ½œåœ¨ä¸ä¸€è‡´é—®é¢˜

### é—®é¢˜1ï¼šè·¯å¾„æ ‡å‡†åŒ–é€»è¾‘åˆ†æ•£ä¸”ä¸ä¸€è‡´

| æ–‡ä»¶ | è·¯å¾„å¤„ç†æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|------------|---------|
| [vulnhalla.py#L487](src/vulnhalla.py#L487-L550) | æ£€æµ‹`:`åˆ¤æ–­Windowsï¼Œç»Ÿä¸€`/`åˆ†éš”ç¬¦ | Issueå¤„ç† |
| [db_lookup.py#L360](src/codeql/db_lookup.py#L356-L373) | ç›´æ¥`[1:]`å»æ‰é¦–å­—ç¬¦ | DBæŸ¥è¯¢ |
| [results_loader.py](src/ui/results_loader.py#L222-L242) | ä½¿ç”¨Pathå¯¹è±¡è§£æ | UIæ˜¾ç¤º |

**é£é™©**ï¼š
- `db_lookup.py`å‡è®¾è·¯å¾„éƒ½æ˜¯Linuxæ ¼å¼ï¼ˆä»¥`/`å¼€å¤´ï¼‰
- å¦‚æœé‡åˆ°Windowsè·¯å¾„`C:\path\file.c`ï¼Œ`[1:]`ä¼šå˜æˆ`:\path\file.c`ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶

---

### é—®é¢˜2ï¼šè·¯å¾„åŒ¹é…æ–¹å¼ä¸åŒ

**vulnhalla.pyçš„find_function_by_lineï¼š**
```python
if file_path in function["file"]:  # âœ… åŒå‘åŒ¹é…
    if file_path in function["file"]:
        size = end_line - start_line
        if size < smallest_range:
            best_function = function
```

**db_lookup.pyçš„get_function_by_lineï¼š**
```python
if file in function:  # âš ï¸ å•å‘å­ä¸²åŒ¹é…
    row_dict = parse_csv_row(function, keys)
    if start <= line <= end:
        return row_dict  # ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰æ‰¾æœ€åŒ¹é…çš„å‡½æ•°
```

**å·®å¼‚**ï¼š
- `vulnhalla.py`ä¼šæ‰¾**æœ€ç²¾ç¡®åŒ¹é…**ï¼ˆèŒƒå›´æœ€å°çš„å‡½æ•°ï¼‰
- `db_lookup.py`è¿”å›**ç¬¬ä¸€ä¸ªåŒ¹é…**çš„å‡½æ•°
- å¦‚æœåŒä¸€ä¸ªæ–‡ä»¶æœ‰åµŒå¥—å‡½æ•°ï¼Œå¯èƒ½è¿”å›é”™è¯¯çš„å¤–å±‚å‡½æ•°

---

## æˆ‘çš„å»ºè®®ï¼šé›†ä¸­åŒ–è·¯å¾„å¤„ç†

å¦‚æœè¦äºŒå¼€ï¼Œå»ºè®®åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„è·¯å¾„å¤„ç†æ¨¡å—ï¼š

```python
# src/utils/path_normalizer.py
from pathlib import Path, PurePosixPath

class PathNormalizer:
    """ç»Ÿä¸€çš„è·¯å¾„æ ‡å‡†åŒ–å·¥å…·"""
    
    @staticmethod
    def normalize_db_path(source_location_prefix: str) -> str:
        """
        æ ‡å‡†åŒ–CodeQLæ•°æ®åº“çš„sourceLocationPrefix
        
        å¤„ç†åœºæ™¯ï¼š
        - Linux: /absolute/path â†’ absolute/path
        - Windows: C:\\path â†’ C_/path
        """
        if ":" in source_location_prefix:
            # Windowsè·¯å¾„
            return source_location_prefix.replace(":", "_").replace("\\", "/")
        else:
            # Linuxè·¯å¾„
            return source_location_prefix[1:] if source_location_prefix.startswith("/") else source_location_prefix
    
    @staticmethod
    def normalize_file_path(file_path: str) -> str:
        """æ ‡å‡†åŒ–æ–‡ä»¶è·¯å¾„ï¼ˆå»æ‰å¼•å·ï¼Œç»Ÿä¸€åˆ†éš”ç¬¦ï¼‰"""
        return file_path.replace("\"", "").replace("\\", "/")
    
    @staticmethod
    def build_full_path(base_path: str, relative_path: str) -> str:
        """æ„å»ºå®Œæ•´è·¯å¾„ï¼Œå¤„ç†å¯èƒ½çš„è·¯å¾„å‰ç¼€å·®å¼‚"""
        normalized_base = PathNormalizer.normalize_db_path(base_path)
        normalized_rel = PathNormalizer.normalize_file_path(relative_path)
        return f"{normalized_base}{normalized_rel}"
```

ç„¶ååœ¨æ‰€æœ‰æ–‡ä»¶ä¸­æ›¿æ¢è·¯å¾„å¤„ç†é€»è¾‘ï¼Œè¿™æ ·ï¼š
1. **ä¸€è‡´æ€§å¥½**ï¼šæ‰€æœ‰è·¯å¾„å¤„ç†ç”¨åŒä¸€å¥—è§„åˆ™
2. **æ˜“è°ƒè¯•**ï¼šè·¯å¾„é—®é¢˜åªåœ¨ä¸€ä¸ªåœ°æ–¹ä¿®å¤
3. **æ˜“æ‰©å±•**ï¼šæ–°æƒ…å†µåªéœ€ä¿®æ”¹ä¸€ä¸ªç±»

---

## æ€»ç»“

**æ‰€æœ‰è·¯å¾„å¤„ç†ä»£ç çš„åˆ†å¸ƒï¼š**

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | ä¼˜å…ˆçº§ï¼ˆä¿®å¤å»ºè®®ï¼‰ |
|------|---------|------------------|
| Issueè·¯å¾„æ ‡å‡†åŒ– | [vulnhalla.py#L487](src/vulnhalla.py#L487-L550) | â­â­â­ é«˜ |
| Bracket referenceè·¯å¾„è§£æ | [vulnhalla.py#L224](src/vulnhalla.py#L224-L272) | â­â­â­ é«˜ |
| DBæŸ¥è¯¢è·¯å¾„å¤„ç† | [db_lookup.py#L360](src/codeql/db_lookup.py#L356-L373) | â­â­ ä¸­ |
| å‡½æ•°æŸ¥æ‰¾è·¯å¾„åŒ¹é… | [db_lookup.py#L84](src/codeql/db_lookup.py#L84-L113) | â­â­ ä¸­ |
| ç»“æœæ–‡ä»¶è·¯å¾„è§£æ | [results_loader.py](src/ui/results_loader.py#L222-L242) | â­ ä½ |
| ZIPæ–‡ä»¶è¯»å– | [common_functions.py#L122](src/utils/common_functions.py#L122-L148) | â­ ä½ï¼ˆåº•å±‚çš„å·¥å…·å‡½æ•°ï¼Œç›¸å¯¹ç¨³å®šï¼‰ |

